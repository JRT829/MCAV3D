<!DOCTYPE html>
<html>
  <head>
    <title>MCAV Public Transport Integration Visualisation</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="shortcut icon" href="#" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
 
  </head>
  <body>
    <div id="map"></div><!--Placeholder for map -->
 
  
 
  <script src="{{url_for('static', filename='js/main.js')}}"></script><!--Connecting html with javascript-->
  
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCJcC-iTbiurisPUUqn6dd3LVtadL57XEI&callback=initMap"
    async defer></script><!--Google Maps API access-->
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"  ></script><!--Socket.IO access -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/102/three.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.2/TweenMax.min.js" ></script>
    <script >
  
      
      
     
      let socket = io('http://localhost:5000');//Initialising socket.IO server
      const tramicon= 'https://img.icons8.com/cotton/30/000000/tram--v6.png'
      const busicon= 'https://img.icons8.com/office/16/000000/bus.png'
      const trainicon= 'https://img.icons8.com/emoji/30/000000/train-emoji.png'
      let iconlist=[tramicon,tramicon]
      socket.on('connect', function(){
        console.log('connected')//Testing if connection works and shows on terminal 
        socket.emit('my event', {data: 'I\'m connected!'});
        });
        

      function deleteMarkers(markers){
      
        for(let i=0; i<markers.length;i++){
          markers[i].setMap(null);
          }
          markers = [];
          
          
          }
        
     

      const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms))
      const loop = async () => {
        let connected=true
        while(connected==true){//Creating infinite loop to continously update the data 
      
        let markers=[]//Initialisng markers
        

        socket.emit('spawn')//Activating API call from ptnsw.py
        socket.on('data',function(data){//From emitting event (spawn) this event (tram) is triggered) 
        setTimeout(deleteMarkers(markers),5000)
        for(let i=0;i<data.length;i++){
          
        //console.log(coordinates)//Testing if coordinates are present 
        let latitude=data[i][0]//Extracting coordinates
        let longitude=data[i][1]
        let routeid=data[i][2]
        
        
        for(let j=0;j<routeid.length;j++){//Creating all the markers
          let myLatlng=new google.maps.LatLng(latitude[j],longitude[j])
          let infowindow = new google.maps.InfoWindow({
                  content: routeid[j],
                  });
          let marker=new google.maps.Marker({  
            map: map,
            title:j.toString(),    
            position: myLatlng,
            icon:iconlist[i]
              })

            
            marker.addListener("mouseover", () => {
                infowindow.open({
                anchor: marker,
                map,
                });
            });
            marker.addListener('mouseout', function() {
                infowindow.close();
                });
            markers.push(marker) 

            
                
            }
            
            
          }
          
        }
        )
        
      
      await wait(5000)//Updating frequency
      
      
      console.log(markers)

       }
      }
      loop()//Repeating loop 
        
     

      
        

    </script>
    
    
  </body>

  